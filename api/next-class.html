<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Class API</title>
</head>
<body>
    <script>
        // Import schedule logic from main app
        const dayOfWeekMap = {
            0: "ВС",
            1: "ПН",
            2: "ВТ",
            3: "СР",
            4: "ЧТ",
            5: "ПТ",
            6: "СБ"
        };

        const fullDayNames = {
            "ПН": "Понедельник",
            "ВТ": "Вторник",
            "СР": "Среда",
            "ЧТ": "Четверг",
            "ПТ": "Пятница",
            "СБ": "Суббота",
            "ВС": "Воскресенье"
        };

        function getCurrentWeekType() {
            const startDate = new Date('2025-01-27');
            const currentDate = new Date();
            const timeDiff = currentDate.getTime() - startDate.getTime();
            const weeksPassed = Math.floor(timeDiff / (7 * 24 * 60 * 60 * 1000));
            return weeksPassed % 2 === 0 ? "Зеленая неделя" : "Белая неделя";
        }

        function getCurrentDayOfWeek() {
            return dayOfWeekMap[new Date().getDay()];
        }

        function parseTimeString(timeStr) {
            const [start, end] = timeStr.split(' - ');
            
            const [startHours, startMinutes] = start.split(':').map(Number);
            const startDate = new Date();
            startDate.setHours(startHours, startMinutes, 0, 0);
            
            const [endHours, endMinutes] = end.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(endHours, endMinutes, 0, 0);
            
            return { start: startDate.getTime(), end: endDate.getTime() };
        }

        function getWeekTypeForDate(date) {
            const startDate = new Date('2025-01-27');
            const timeDiff = date.getTime() - startDate.getTime();
            const weeksPassed = Math.floor(timeDiff / (7 * 24 * 60 * 60 * 1000));
            return weeksPassed % 2 === 0 ? "Зеленая неделя" : "Белая неделя";
        }

        async function getNextClass() {
            try {
                // Try to load schedule data
                let scheduleData;
                
                try {
                    const response = await fetch('../schedule.json');
                    scheduleData = await response.json();
                } catch (networkError) {
                    // Try localStorage as fallback
                    const cachedData = localStorage.getItem('scheduleData');
                    if (cachedData) {
                        scheduleData = JSON.parse(cachedData);
                    } else {
                        throw new Error('No schedule data available');
                    }
                }

                const now = new Date();
                const currentWeekType = getCurrentWeekType();
                const currentDay = getCurrentDayOfWeek();
                
                // Check remaining classes today
                const todayClasses = scheduleData[currentWeekType] && scheduleData[currentWeekType][currentDay];
                if (todayClasses && todayClasses.length > 0) {
                    for (const classItem of todayClasses) {
                        const { start } = parseTimeString(classItem.time);
                        if (start > now.getTime()) {
                            return {
                                success: true,
                                data: {
                                    subject: classItem.subject,
                                    time: classItem.time,
                                    room: classItem.room,
                                    type: classItem.type,
                                    day: fullDayNames[currentDay],
                                    isToday: true,
                                    date: 'Сегодня'
                                }
                            };
                        }
                    }
                }
                
                // Check tomorrow and subsequent days
                let checkDate = new Date(now);
                checkDate.setDate(checkDate.getDate() + 1);
                
                for (let i = 0; i < 14; i++) { // Check up to 2 weeks ahead
                    const checkDay = dayOfWeekMap[checkDate.getDay()];
                    const checkWeekType = getWeekTypeForDate(checkDate);
                    
                    const dayClasses = scheduleData[checkWeekType] && scheduleData[checkWeekType][checkDay];
                    if (dayClasses && dayClasses.length > 0) {
                        return {
                            success: true,
                            data: {
                                subject: dayClasses[0].subject,
                                time: dayClasses[0].time,
                                room: dayClasses[0].room,
                                type: dayClasses[0].type,
                                day: fullDayNames[checkDay],
                                isToday: false,
                                date: checkDate.toLocaleDateString('ru-RU')
                            }
                        };
                    }
                    
                    checkDate.setDate(checkDate.getDate() + 1);
                }
                
                return {
                    success: false,
                    message: "Нет предстоящих занятий"
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Initialize and return data
        document.addEventListener('DOMContentLoaded', async () => {
            const result = await getNextClass();
            
            // Set content type for JSON
            document.head.innerHTML += '<meta http-equiv="Content-Type" content="application/json; charset=utf-8">';
            
            // Display JSON
            document.body.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            
            // Also make it available for programmatic access
            window.nextClassData = result;
        });
    </script>
</body>
</html>

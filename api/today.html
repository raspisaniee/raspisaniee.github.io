<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today Schedule API</title>
</head>
<body>
    <script>
        // Import schedule logic from main app
        const dayOfWeekMap = {
            0: "ВС",
            1: "ПН",
            2: "ВТ",
            3: "СР",
            4: "ЧТ",
            5: "ПТ",
            6: "СБ"
        };

        const fullDayNames = {
            "ПН": "Понедельник",
            "ВТ": "Вторник",
            "СР": "Среда",
            "ЧТ": "Четверг",
            "ПТ": "Пятница",
            "СБ": "Суббота",
            "ВС": "Воскресенье"
        };

        function getCurrentWeekType() {
            const startDate = new Date('2025-01-27');
            const currentDate = new Date();
            const timeDiff = currentDate.getTime() - startDate.getTime();
            const weeksPassed = Math.floor(timeDiff / (7 * 24 * 60 * 60 * 1000));
            return weeksPassed % 2 === 0 ? "Зеленая неделя" : "Белая неделя";
        }

        function getCurrentDayOfWeek() {
            return dayOfWeekMap[new Date().getDay()];
        }

        function parseTimeString(timeStr) {
            const [start, end] = timeStr.split(' - ');
            
            const [startHours, startMinutes] = start.split(':').map(Number);
            const startDate = new Date();
            startDate.setHours(startHours, startMinutes, 0, 0);
            
            const [endHours, endMinutes] = end.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(endHours, endMinutes, 0, 0);
            
            return { start: startDate.getTime(), end: endDate.getTime() };
        }

        function isCurrentClass(timeStr) {
            const now = Date.now();
            const { start, end } = parseTimeString(timeStr);
            return now >= start && now <= end;
        }

        async function getTodaySchedule() {
            try {
                // Try to load schedule data
                let scheduleData;
                
                try {
                    const response = await fetch('../schedule.json');
                    scheduleData = await response.json();
                } catch (networkError) {
                    // Try localStorage as fallback
                    const cachedData = localStorage.getItem('scheduleData');
                    if (cachedData) {
                        scheduleData = JSON.parse(cachedData);
                    } else {
                        throw new Error('No schedule data available');
                    }
                }

                const weekType = getCurrentWeekType();
                const dayOfWeek = getCurrentDayOfWeek();
                
                if (!scheduleData || !scheduleData[weekType] || !scheduleData[weekType][dayOfWeek]) {
                    return {
                        success: true,
                        data: {
                            day: fullDayNames[dayOfWeek],
                            weekType: weekType,
                            classes: [],
                            message: "Сегодня нет занятий",
                            currentClass: null,
                            nextClass: null
                        }
                    };
                }
                
                const classes = scheduleData[weekType][dayOfWeek].map(classItem => ({
                    ...classItem,
                    isCurrent: isCurrentClass(classItem.time),
                    isFinished: parseTimeString(classItem.time).end < Date.now()
                }));
                
                return {
                    success: true,
                    data: {
                        day: fullDayNames[dayOfWeek],
                        weekType: weekType,
                        classes: classes,
                        currentClass: classes.find(c => c.isCurrent) || null,
                        nextClass: classes.find(c => parseTimeString(c.time).start > Date.now()) || null,
                        totalClasses: classes.length,
                        finishedClasses: classes.filter(c => c.isFinished).length
                    }
                };
                
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Initialize and return data
        document.addEventListener('DOMContentLoaded', async () => {
            const result = await getTodaySchedule();
            
            // Set content type for JSON
            document.head.innerHTML += '<meta http-equiv="Content-Type" content="application/json; charset=utf-8">';
            
            // Display JSON
            document.body.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            
            // Also make it available for programmatic access
            window.todayScheduleData = result;
        });
    </script>
</body>
</html>
